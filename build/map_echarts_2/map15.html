<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
</head>

<body style="position:relative;">
    <div id="main"></div>
    <div id="main-popup">
        <div class="left"><div id="svg-area"></div></div>
        <div class="right">
            <h2><i></i></h2>
            <div class="capital" style="margin-top:8px">
                <label>CAPITAL:</label>
                <span></span>
            </div>
            <div class="gdp">
                <label>GDP:</label>
                <span></span>
            </div>
            <div class="population">
                <label>POPULATION:</label>
                <span></span>
                <em></em>
            </div>
            <div class="impression">
                <label>IMPRESSION:</label>
                <span></span>
            </div>
            <div class="click">
                <label>CLICK:</label>
                <span></span>
            </div>
            <div class="top5">
                <label>TOP 5 ADVERTISER:</label>
                <div class="imgarea"></div>
            </div>
        </div>
    </div>
</body>
<script src="./echarts-2.2.7/build/dist/echarts-all.js"></script>
<script src="./jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="./geojson/geojson.js"></script>
<script type="text/javascript" src="./lonlat.js"></script>
<script src="./nn.js"></script>

<style>
    html,body,#main{height: 100%}
    #main{
        background:url(./images/timeline.svg) no-repeat; 
        background-size:100% 100%; 
        /*padding-top:60px; */
    }
    #main-popup{
        display: none;
        width:532px;height: 350px;
        position: absolute; 
        top:50%;left: 50%;
        margin-left: -266px;
        margin-top:-175px;
        background:url(./images/popupbg.svg) no-repeat;
    }
    #main-popup .left{float:left;padding:20px;line-height:300px}
    #svg-area{width: 172px;height:172px; display: inline-block;vertical-align: middle;};
    #main-popup .right { width: 320px; height:350px; float: left; color:#00dbff; font-family: 'Helvetica';}
    #main-popup .right h2{font-weight: 800; margin: 0;padding:50px 0 8px 0;color:#FFF;}
    #main-popup .right h2 em{width:30px;height:30px;display: inline-block;margin-right: 5px;vertical-align: bottom;background-size: cover;}
    #main-popup .right div{color:#00dbff;padding:4px 0 }
    #main-popup .right label, #main-popup .right .top5{color:#fff;}
    
</style>

<script type="text/javascript">
    var __lonlat = new Lonlat();
    var mapData =null;
    mapData = JSON.parse(localStorage.LOCAL_DATA).common.geoDailyForPopup;
    var geoForMapData = JSON.parse(localStorage.LOCAL_DATA).common.geoForMap;
    var starttime = localStorage.START_TIME;

    let px2rem = localStorage.PX2REM; // 当前页面的rem基准值

    // Math.floor(Math.random() * (300-200+1) + 200))

    let impressCardinalNumber = 34;
    
    function getCurrentData(start,increase){
        var second = (new Date().getTime() - starttime)/1000;
        var data = Math.floor((increase/1800) * second + start);
        // console.log(second, 1,data);
        return data;      
    }

    function getJwData(){
        let __jwl = [];
        var placeList = [];

        for(let p in geoForMapData){
            let start = geoForMapData[p].start,
                increase = geoForMapData[p].increase,
                mun =4000;

            let currntData = getCurrentData(start,increase);

            let c = Math.floor(currntData/mun);
            // __jwl.push();
            let s = __lonlat.getLonLat(p.toUpperCase(),c);

            $.each(s, function(index, value) {

                placeList.push({
                    name: '',
                    geoCoord: [value.lon, value.lat]
                });
            });

        }
        // console.log('map',placeList.length)
        return placeList;
    };

    

    function currntData() {
        var data = [];
        var placeList = getJwData();
        var len = placeList.length;
        while (len--) {
            data.push({
                name: placeList[len].name,
                value: 1,
                geoCoord: placeList[len].geoCoord
            })
        }
        return data;
    }


   

   function getOption(currnt){
    return {
        // backgroundColor: _color,
        color: ['red','gray','#FAFDFE'
            // 'rgba(255, 255, 255, 0.1)',
            // 'rgba(14, 241, 242, 0.1)',
            // 'rgba(37, 140, 249, 0.1)'
        ],
        legend: {
            show: false,
            orient: 'vertical',
            x: 'left',
            data: ['强', '中', '弱'],
            textStyle: {
                color: '#fff'
            }
        },
        roamController: {
            show: true,//px2rem>400 ? false : true,
            x: 'right',
            // zlevel:2,
            // z:'1000',
            y:'bottom',
            // width:'60',
            // height:'120',
            padding:[.20*px2rem,.20*px2rem,-.20*px2rem,.50*px2rem],
            backgroundColor:'rgba(0,0,0,0)',
            borderColor:'yellow',
            handleColor: 'rgba(255,255,255,0.5)',
            fillColor:'blue',
            mapTypeControl: {
                'world': true
            }
        },
        geo:{
            map:'world',
            label:{},
            itemStyle:{
                normal:{
                    color:'red',
                    borderColor:'#00EDFF',
                },
                emphasis:{
                    color:'#09182c',
                    borderColor:'#fff',
                },
            },

        },
        series: [

            {
                name: '强',
                type: 'map',
                mapType: 'world',
                hoverable: true,
                roam: true,
                //地图数值计算结果小数精度，mapValueCalculation为average时有效，默认为取整，需要小数精度时设置大于0的整数
                //mapValuePrecision:0,
                selectedMode: 'single',
                itemStyle:{
                    normal:{
                        show:true,
                        color:'#000115',
                        borderColor:'#00EDFF',
                        borderWidth:.01*px2rem,
                    },
                    emphasis:{
                        show:false,
                        borderColor:'#fefefe',
                        color:'rgba(0,0,0,0)',
                    },
                },
                // roam:'false', //scale 滚轮缩放,//
                data: [],
                markPoint: {
                    symbol: 'circle',
                    clickable: false,
                    symbolSize: .01*px2rem,
                    large: true,
                    effect: {
                        // type:'bounce',
                        loop:false,
                        show: true,
                        period: 10,
                        scaleSize: .01*px2rem
                    },
                    itemStyle:{
                        normal:{
                            show:true,
                            color:'#FFF',
                            borderColor:'#00EDFF',
                        },
                    },

                    data: currnt                
                }
            }
        ]
    }}


    var _toupincfg ={
        impression:0.679,
    }

    // 用来弹出窗口的配置用的
    var _option = {
        series: [{
            name: '',
            type: 'map',
            mapType: 'china',
            selectedMode: 'single',
            itemStyle: {
                normal: {
                    label: {
                        show: false
                    }
                },
                emphasis: {
                    label: {
                        show: false
                    }
                }
            },
            data: []
        }]
    };

        


    var myChart = echarts.init(document.getElementById('main'));
    // 用于弹出窗口显示国家形状
    var myChartForPopup = echarts.init(document.getElementById('svg-area'));
     
    function render(){
       let option = getOption(currntData());
       myChart.setOption(option, true);
 
    }

    render();

    setInterval(render,10000);

    

    let everyHalfRequestData = function(){
            let time = new Date().toTimeString();
            let timeNum = time.slice(3,5);
            if (timeNum == '41'|| timeNum == '11') {
                 let nowtime = new Date().getTime();
                  let c;
                 let starttime = localStorage.START_CHECK;
                 if(typeof starttime!= 'undefined') {
                    starttime = Number(starttime);
                    c = nowtime-starttime;
                }
                 // console.log(c,nowtime,starttime);
                 // console.log('222')
                 if ((typeof c!= 'undefined' && c>60000) || (typeof starttime == 'undefined') ){
                        // getJson(options,setStore);
                        // myChart.setOption(getOption(currntData()), true);
                        render();
                        localStorage.START_CHECK = nowtime;
                 }

                 
            }
    };

    everyHalfRequestData();
    let timeTicket = setInterval(everyHalfRequestData,31000);

    function renderPopUpHtml(data,p){
        var _p = p.replace(/ /g,'%20');
        if (typeof data=='undefined') {return false}
        $('#main-popup .right h2').empty().html('<em style="background:url(../src/images/png/'+_p+'.png) no-repeat; background-size:cover;"></em>'+ p)
        $('.capital span').empty().html(data.capital)
        $('.gdp span').empty().html(data.gdp + ' '+'Billion USD');
        $('.population span').empty().html(data.population);
        $('.impression span').empty().html(Math.floor(data.click)*impressCardinalNumber);
        $('.click span').empty().html(data.click);
        var str ='';
        var top5 = data.appTopFive;
        for (var i = top5.length - 1; i >= 0; i--) {
            str+= '<img style="width:30px;height:30px;margin:3px;" src="'+top5[i].icon+'"/>';
        }
        $('.top5 .imgarea').empty().html(str);
        // console.log(3,data,p)                        
   }


    function _flipObject(o){
        var newO ={};
        for(var s in o){newO[o[s]]= s}
        return newO;
    }


    myChart.on(echarts.config.EVENT.MAP_SELECTED, function (param){
        let e = window.event;
        e.stopPropagation();
        
        for (var p in param.selected) {
            //
            
            if (param.selected[p]) {
                // console.log(p,'name_to_code:',name_to_code[p])
                if(typeof name_to_code[p] =='undefined'){
                  console.log(name_to_code[p]);
                  return false; 
                }
                                    
                var geo = name_to_code[p];
                
                // 注册新的地图
                echarts.util.mapData.params.params[geo] = {
                    getGeoJson: function (callback) {
                        $.getJSON('./geojson/countries/'+geo+'.geo.json', callback);
                    }
                };

                _option.series[0].mapType = geo;
                myChartForPopup.setOption(_option, true);
              
               var g = _flipObject(__tw)[geo];
               if (typeof g == 'undefined') {return false;}              
               var gg = g.toLowerCase();

               // console.log(g,gg,mapData,mapData[gg])
              
               if (typeof mapData[gg]=='undefined') {return false}
               // console.log(p,name_to_code[p],g,gg,param.selected)
               renderPopUpHtml(mapData[gg],p);
                                  
            }
        } 

        $('#main-popup').show();


    });



    $('#main-popup').on('click',function(e){
        e.stopPropagation();
        $(this).hide();
    })
        
</script>
</html>
